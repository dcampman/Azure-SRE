{
  "handler": "Microsoft.Azure.CreateUIDef",
  "version": "0.1.2-preview",
  "parameters": {
    "config": {
      "isWizard": false,
      "basics": {
        "description": "Customized description with dave **markdown**.",
        "subscription": {
          "constraints": {
            "validations": [
              {
                "isValid": "[not(contains(subscription().displayName, 'HUB'))]",
                "message": "Can't use test subscription."
              },
              {
                "permission": "Microsoft.ContainerInstance/containerGroups/*",
                "message": "Must have write permission for the extension."
              },
              {
                "permission": "Microsoft.Resources/deployments/*",
                "message": "Must have write permission for the extension."
              },
              {
                "permission": "Microsoft.Resources/deploymentScripts/*",
                "message": "Must have write permission for the extension."
              }
            ]
          },
          "resourceProviders": [
            "Microsoft.DataFactory",
            "microsoft.insights",
            "Microsoft.ManagedIdentity",
            "Microsoft.ContainerInstance",
            "Microsoft.Logic",
            "Microsoft.Management",
            "Microsoft.ApiManagement",
            "Microsoft.Storage",
            "Microsoft.DesktopVirtualization",
            "Microsoft.EventGrid",
            "Microsoft.OperationalInsights",
            "Microsoft.Web",
            "Microsoft.Compute",
            "Microsoft.Network",
            "Microsoft.ResourceGraph",
            "Microsoft.Resources"
          ]
        },
        "location": {
          "label": "Location",
          "toolTip": "Azure Region for this deployment",
          "resourceTypes": ["Microsoft.Compute/virtualMachines"],
          "allowedValues": [
            "CentralUS",
            "EastUS",
            "EastUS2",
            "NorthCentralUS",
            "SouthCentralUS",
            "WestCentralUS",
            "WestUS",
            "WestUS2",
            "WestUS3"
          ]
        }
      }
    },
    "basics": [
      {
        "name": "environment",
        "type": "Microsoft.Common.DropDown",
        "label": "Environment",
        "defaultValue": "Production",
        "toolTip": "",
        "constraints": {
          "required": true,
          "allowedValues": [
            {
              "label": "Development",
              "value": "dev"
            },
            {
              "label": "Test",
              "value": "test"
            },
            {
              "label": "Production",
              "value": "prod"
            },
            {
              "label": "Sandbox",
              "value": "sandbox"
            },
            {
              "label": "Staging",
              "value": "staging"
            },
            {
              "label": "Shared",
              "value": "shared"
            },
            {
              "label": "UAT",
              "value": "uat"
            }
          ]
        },
        "visible": true
      },
      {
        "name": "loggingConfig",
        "type": "Microsoft.Common.Section",
        "label": "Configure Diagnostics Logging",
        "elements": [
          {
            "name": "logAnalyticsSelector",
            "type": "Microsoft.Solutions.ResourceSelector",
            "label": "Select Log Anlytics Workspace",
            "resourceType": "Microsoft.OperationalInsights/workspaces",
            "options": {
              "filter": {
                "subscription": "onBasics",
                "location": "onBasics"
              }
            }
          }
        ]
      }
    ],
    "steps": [
      {
        "name": "workspaceConfig",
        "label": "Workspace Configuration",
        "elements": [
          {
            "name": "workspaceName",
            "type": "Microsoft.Common.TextBox",
            "label": "Workspace Name",
            "defaultValue": "",
            "toolTip": "Name of the workspace to include in the naming of resources. This value will be truncated to 6 characters in resource names but the full value will be present in tags on resources.",
            "constraints": {
              "required": true,
              "regex": "",
              "validationMessage": ""
            },
            "visible": true
          },
          {
            "name": "instance",
            "type": "Microsoft.Common.TextBox",
            "label": "Instance",
            "defaultValue": "1",
            "toolTip": "Instance suffix for resources. Presented as two digits in the naming convention.",
            "constraints": {
              "required": false,
              "regex": "^[0-9|0-9]{1,2}$",
              "validationMessage": ""
            },
            "visible": true
          },
          {
            "name": "networkingConfig",
            "type": "Microsoft.Common.Section",
            "label": "Virtual Network",
            "elements": [
              {
                "name": "virtualNetwork",
                "type": "Microsoft.Network.VirtualNetworkCombo",
                "label": {
                  "virtualNetwork": "Virtual network",
                  "subnets": "Subnets"
                },
                "toolTip": {
                  "virtualNetwork": "",
                  "subnets": ""
                },
                "defaultValue": {
                  "name": "core",
                  "addressPrefixSize": "/24"
                },
                "constraints": {
                  "minAddressPrefixSize": "/24"
                },
                "options": {
                  "hideExisting": false
                },
                "subnets": {
                  "subnet1": {
                    "label": "Private Endpoints Subnet",
                    "defaultValue": {
                      "name": "privateEndpoints",
                      "addressPrefixSize": "/25"
                    },
                    "constraints": {
                      "minAddressPrefixSize": "/27",
                      "minAddressCount": 8,
                      "requireContiguousAddresses": false
                    }
                  },
                  "subnet2": {
                    "label": "Workload Compute Subnet",
                    "defaultValue": {
                      "name": "compute",
                      "addressPrefixSize": "/25"
                    },
                    "constraints": {
                      "minAddressPrefixSize": "/27",
                      "minAddressCount": 8,
                      "requireContiguousAddresses": false
                    }
                  }
                },
                "visible": true
              },
              {
                "name": "vnetSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Virtual Network",
                "resourceType": "Microsoft.Network/virtualNetworks",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                }
              }
            ]
          },
          {
            "name": "storageConfig",
            "type": "Microsoft.Common.Section",
            "label": "Private Storage",
            "elements": [
              {
                "name": "storageSelector",
                "type": "Microsoft.Solutions.ResourceSelector",
                "label": "Private Storage Accounts",
                "resourceType": "Microsoft.Storage/storageAccounts",
                "options": {
                  "filter": {
                    "subscription": "onBasics",
                    "location": "onBasics"
                  }
                }
              }
            ]
          }
        ]
      },
      {
        "name": "dataAutomationConfig",
        "label": "Data Automation Configuration",
        "elements": [
          {
            "name": "approverEmail",
            "type": "Microsoft.Common.TextBox",
            "label": "Approver Email",
            "defaultValue": "",
            "toolTip": "Email address of the appover responsible for validating the data is ready to be released.",
            "constraints": {
              "required": true,
              "regex": "[a-z0-9!#$%&'*+/=?^_'{|}~-]+(?:\\.[a-z0-9!#$%&'*+/=?^_'{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?",
              "validationMessage": ""
            },
            "visible": true
          },
          {
            "name": "identityConfig",
            "type": "Microsoft.Common.Section",
            "label": "Managed Identity",
            "elements": [
              {
                "name": "identity",
                "type": "Microsoft.ManagedIdentity.IdentitySelector",
                "label": "Managed Identity Configuration",
                "toolTip": {
                  "userAssignedIdentity": "Add user assigned identities to grant the resource access to other existing resources."
                },
                "defaultValue": {
                  "systemAssignedIdentity": "Off"
                },
                "options": {
                  "hideSystemAssignedIdentity": true,
                  "hideUserAssignedIdentity": false
                },
                "visible": true
              }
            ]
          }
        ]
      },
      {
        "name": "tags",
        "label": "Tags",
        "elements": [
          {
            "name": "tags",
            "type": "Microsoft.Common.TagsByResource",
            "resources": ["All Resources"]
          }
        ]
      }
    ],
    "outputs": {
      "environment": "[basics('environment')]",
      "workspaceName": "[steps('workspaceConfig').workspaceName]",
      "sequence": "[steps('workspaceConfig').instance]",
      "approverEmail": "[steps('dataAutomationConfig').approverEmail]",
      "tags": "[steps('tags').tags]"
    }
  }
}
